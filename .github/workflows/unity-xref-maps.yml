name: Generate Unity XRef Maps
on:
  schedule:
    # do once a week at midnight on Sunday
    - cron: '0 0 * * 0'
  workflow_dispatch:
permissions:
  actions: read
  pages: write
  id-token: write
concurrency:
  group: unity-xref-maps
  cancel-in-progress: true
jobs:
  # enumerate all unity versions based on branch names of UnityCsReference repo
  get_unity_versions:
    runs-on: ubuntu-latest
    outputs:
      UNITY_VERSIONS: ${{ steps.get_unity_versions.outputs.UNITY_VERSIONS }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Unity-Technologies/UnityCsReference
          fetch-depth: 0
          path: UnityCsReference
      # get the unity versions from the branch names and drop origin/ prefix as json array
      - id: get_unity_versions
        run: |
          BRANCHES=$(git -C UnityCsReference branch -r --list 'origin/[0-9]*.[0-9]*')
          VERSIONS=$(echo "$BRANCHES" | sed 's|origin/||g' | tr -s ' ' '\n' | jq -R -s 'split("\n") | map(select(. != ""))' | jq -c .)
          echo "Versions: $VERSIONS"
          echo "UNITY_VERSIONS=$VERSIONS" >> "$GITHUB_OUTPUT"
  # genearte docfx metadata for each unity version
  generate_metadata:
    needs: get_unity_versions
    runs-on: windows-latest
    strategy:
      matrix:
        unity_version: ${{ fromJson(needs.get_unity_versions.outputs.UNITY_VERSIONS) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: Unity-Technologies/UnityCsReference
          path: UnityCsReference
          ref: ${{ matrix.unity_version }}
      # - uses: actions/setup-dotnet@v4
      #   with:
      #     dotnet-version: 8.x
      - run: |
          echo "::group::DocFX metadata ${{ matrix.unity_version }}"

          dotnet tool install -g docfx

          # for versions between 2019.1 and 2021.3 (inclusive) add Debug configuration property
          if (${{ matrix.unity_version }} -like '2019.*' -or ${{ matrix.unity_version }} -like '2020.*' -or ${{ matrix.unity_version }} -like '2021.*') {
            docfx metadata ${{ github.workspace }}/.docfx/docfx.json --output ${{ github.workspace }}/.docfx/xref/${{ matrix.unity_version }} --logLevel diagnostic --property Configuration=Debug
          }
          else {
            docfx metadata ${{ github.workspace }}/.docfx/docfx.json --output ${{ github.workspace }}/.docfx/xref/${{ matrix.unity_version }} --logLevel diagnostic
          }

          # check if metadata generation was successful
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to generate metadata for Unity version ${{ matrix.unity_version }}"
            exit 1
          }

          # check if directory exists
          if (-Not (Test-Path -Path ${{ github.workspace }}/.docfx/xref/${{ matrix.unity_version }} -PathType Container)) {
            Write-Error "No xref directory found for Unity version ${{ matrix.unity_version }}"
            exit 1
          }

          # check if xref directory is not empty
          if (-Not (Get-ChildItem -Path ${{ github.workspace }}/.docfx/xref/${{ matrix.unity_version }})) {
            Write-Error "No metadata found for Unity version ${{ matrix.unity_version }}"
            exit 1
          }

          echo "::endgroup::"
          # Additional logging
          echo "::group::Directory contents after generation"
          Get-ChildItem -Recurse ${{ github.workspace }}/.docfx/xref/
          echo "::endgroup::"
        shell: pwsh
        name: Generate Xref Metadata
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          retention-days: 1
          name: ${{ matrix.unity_version }}-metadata
          path: ${{ github.workspace }}/.docfx/xref/${{ matrix.unity_version }}/
  generate_xref_map:
    needs: [generate_metadata, get_unity_versions]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        unity_version: ${{ fromJson(needs.get_unity_versions.outputs.UNITY_VERSIONS) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.unity_version }}-metadata
      - run: |
          chmod +x ${{ github.workspace }}/generate-xref-map.sh
          echo "::group::Generate xref map for Unity version ${{ matrix.unity_version }}"
          ${{ github.workspace }}/generate-xref-map.sh ${{ matrix.unity_version }} ${{ github.workspace }}/.docfx/xref/${{ matrix.unity_version }} ${{ github.workspace }}/_site
          # Ensure generation script succeeded
          if [ $? -ne 0 ]; then
            echo "Failed to generate xref map for Unity version ${{ matrix.unity_version }}"
            exit 1
          fi
          echo "::endgroup::"
        shell: bash
        name: Generate Xref Map
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          retention-days: 1
          name: xref-${{ matrix.unity_version }}
          path: ${{ github.workspace }}/_site/
  # get the xref maps from the artifacts and publish them to gh-pages
  publish_xref_maps:
    needs: generate_xref_map
    runs-on: ubuntu-latest
    steps:
      # download all xref maps from the artifacts
      - uses: actions/download-artifact@v4
        with:
          name: xref-*
          path: ${{ github.workspace }}/_site/
      # make sure the _site directory exists and is populated by the xref maps
      - run: |
          if [ ! -d ${{ github.workspace }}/_site ]; then
            # fail the job if _site directory does not exist
            echo "No xref maps found in _site directory"
            exit 1
          fi
          # list all xref maps in _site directory
          ls -R ${{ github.workspace }}/_site
          # check if _site directory is not empty
          if [ ! "$(ls -R ${{ github.workspace }}/_site)" ]; then
            # fail the job if _site directory is empty
            echo "No xref maps found in _site directory"
            exit 1
          fi
      # generate index.html for the xref maps in _site
      - run: |
          echo "<html><head><title>Unity XRef Maps</title></head><body><h1>Unity XRef Maps</h1><ul>" > ${{ github.workspace }}/_site/index.html
          for f in ${{ github.workspace }}/xref-*/index.html; do
            # use relative path to _site and only show the version number in link text
            echo "<li><a href=\"${f#${{ github.workspace }}/_site/}\">${f#${{ github.workspace }}/xref-}</a></li>" >> ${{ github.workspace }}/_site/index.html
          done
          echo "</ul></body></html>" >> ${{ github.workspace }}/_site/index.html
      - uses: actions/upload-pages-artifact@v3
      - uses: actions/deploy-pages@v4
